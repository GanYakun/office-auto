<ofbiz-edm xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:noNamespaceSchemaLocation="https://dev.odatalab.com/dtds/edmconfig.xsd" ImportGlobal="false">

    <!-- ==============采购主对象（PurchaseRequest、Requirement、PurchaseQuote、PurchaseOrder）=============-->
    <!--PurchaseRequest（采购请求）-->
    <EntityType Name="PurchaseRequest" OfbizEntity="CustRequest" EntityCondition="custRequestTypeId=RF_PUR_QUOTE"
                AutoProperties="true"
                EntitySetName="PurchaseRequests" AutoSet="true">

        <HeaderInfo TypeName="Purchase Request" TypeNamePlural="Purchase Requests">
            <Title Path="custRequestName"/>
            <Description Path="description"/>
        </HeaderInfo>

        <!--在Requirement里显示-->
        <LineItem Qualifier="RelatedRequirement">
            <DataField Values="fromPartyId,createdDate,responseRequiredDate,reason" Importance="High"/>
        </LineItem>

        <!--在Quote里显示-->
        <LineItem Qualifier="RelatedPurchaseQuote">
            <DataField Values="fromPartyId,createdDate,responseRequiredDate,reason" Importance="High"/>
        </LineItem>

        <LineItem>
            <DataField Values="fromPartyId,createdDate,responseRequiredDate,reason" Importance="High"/>
        </LineItem>

        <NavigationProperty Name="ProductRequirement" Type="ProductRequirement" Relations="RequirementCustRequest/Requirement" IsCollection="true"/>
        <NavigationProperty Name="PurchaseQuote" Type="PurchaseQuote" Relations="Quote"/>

    </EntityType>

    <EntityType Name="CatalogRequest" OfbizEntity="CustRequest" EntityCondition="custRequestTypeId=RF_CATALOG"
                AutoProperties="true"
                EntitySetName="CatalogRequests" AutoSet="true">

        <HeaderInfo TypeName="Purchase Request" TypeNamePlural="Purchase Requests">
            <Title Path="custRequestName"/>
            <Description Path="description"/>
        </HeaderInfo>

        <LineItem>
            <DataField Values="custRequestId,custRequestCategoryId,statusId,reason,custRequestDate" Importance="High"/>
            <DataFieldForAction Action="CreatePurchaseRequest" Label="${Create}" Inline="false" Importance="High" Criticality="Positive" InvocationGrouping="Isolated"/>
        </LineItem>

        <!--在PurchaseQuote里显示-->
        <LineItem Qualifier="RelatedQuote">
            <DataField Values="fromPartyId,createdDate,responseRequiredDate,reason" Importance="High"/>
        </LineItem>

        <Property Name="custRequestCategoryId">
            <Text Path="CustRequestCategory/description" TextArrangement="TextOnly"/>
        </Property>
        <Property Name="statusId">
            <Text Path="CatalogRequestStatus/description" TextArrangement="TextOnly"/>
        </Property>

        <!--关联到采购报价单-->
        <NavigationProperty Name="PurchaseQuote" Type="PurchaseQuote" Relations="Quote" IsCollection="true"/>
        <!--关联到产品需求单-->
        <NavigationProperty Name="ProductRequirement" Type="ProductRequirement" Relations="RequirementCustRequest/Requirement" IsCollection="true"/>
        <!--请求种类-->
        <NavigationProperty Name="CustRequestCategory"/>
        <!--请求项-->
        <NavigationProperty Name="CustRequestItem"/>
        <!--请求状态-->
        <NavigationProperty Name="CatalogRequestStatus" Type="CatalogRequestStatus" Relations="StatusItem"/>

        <Action Name="CreatePurchaseRequest" IsBound="true" EntitySetPath="purchaseRequest" SideEffects="true"
                OfbizService="com.dpbird.odata.events.ActionEvents.createEntity">
            <Parameter Name="catalogRequest" Type="CatalogRequest" Nullable="false" IsCollection="true"/>
            <Parameter Name="custRequestCategoryId" Type="String" Label="${CustRequestCategoryId}">
                <ValueList WithFixedValues="true" CollectionPath="CustRequestCategories">
                    <ParameterInOut ValueListProperty="custRequestCategoryId" LocalDataProperty="custRequestCategoryId"/>
                </ValueList>
            </Parameter>
            <Parameter Name="reason" Type="String" Label="${Reason}"/>
            <Parameter Name="custRequestDate" Type="Timestamp" Label="${CustRequestDate}"/>
            <Parameter Name="custRequestTypeId" Type="String" Hidden="true" DefaultValue="RF_CATALOG"/>
            <Parameter Name="statusId" Type="String" Hidden="true" DefaultValue="ARQ_CREATED"/>
        </Action>
    </EntityType>

    <!--ProductRequirement（Requirement）-->
    <EntityType Name="ProductRequirement" OfbizEntity="Requirement" EntityCondition="requirementTypeId=PRODUCT_REQUIREMENT"
                Properties="requirementId,requirementTypeId,facilityId,estimatedBudget,requiredByDate,productId,statusId,quantity,reason,createdDate,createdByUserLogin"
                EntitySetName="ProductRequirements" AutoSet="true">

        <HeaderInfo TypeName="Requirement" TypeNamePlural="Requirements">
            <Title Path="requirementId"/>
            <Description Path="productId"/>
        </HeaderInfo>

        <LineItem Qualifier="RelatedPurchaseRequest">
            <DataField Values="productId,facilityId,statusId" Importance="High"/>
        </LineItem>

        <Property Name="productId">
            <Text Path="Product/productName" TextArrangement="TextOnly"/>
        </Property>
        <Property Name="facilityId">
            <Text Path="Facility/facilityName" TextArrangement="TextOnly"/>
        </Property>

        <!--关联多个采购请求单-->
        <NavigationProperty Name="PurchaseRequest" Type="PurchaseRequest" Relations="RequirementCustRequest/CustRequest" IsCollection="true"/>
        <NavigationProperty Name="Product" IsCollection="false"/>
        <NavigationProperty Name="Facility" IsCollection="false"/>

        <Action Name="CreateProductRequirement" IsBound="true" EntitySetPath="productRequirement" SideEffects="true"
                OfbizService="com.dpbird.odata.events.ActionEvents.createEntity">
            <Parameter Name="productRequirement" Type="ProductRequirement" Nullable="false" IsCollection="true"/>
            <Parameter Name="productId" Type="String" Label="${ProductName}">
                <ValueList CollectionPath="Products" ParameterDisplayOnly="quantityUomId,primaryProductCategoryId">
                    <ParameterInOut LocalDataProperty="productId" ValueListProperty="productId"/>
                </ValueList>
            </Parameter>
            <Parameter Name="facilityId" Type="String" Label="${FacilityName}">
                <ValueList CollectionPath="Facilities" ParameterDisplayOnly="facilitySize,openedDate">
                    <ParameterInOut LocalDataProperty="facilityId" ValueListProperty="facilityId"/>
                </ValueList>
            </Parameter>
            <Parameter Name="quantity" Type="BigDecimal" Scale="2" Label="${Quantity}"/>
            <Parameter Name="requiredByDate" Type="Timestamp" Label="${RequiredByDate}"/>
            <Parameter Name="estimatedBudget" Type="BigDecimal" Scale="2" Label="${EstimatedBudget}"/>
            <Parameter Name="requirementTypeId" Type="String" Hidden="true" DefaultValue="PRODUCT_REQUIREMENT"/>
        </Action>
    </EntityType>

    <!--PurchaseQuote（报价）-->
    <EntityType Name="PurchaseQuote" OfbizEntity="Quote" EntityCondition="quoteTypeId=PURCHASE_QUOTE" EntitySetName="PurchaseQuotes"
                AutoProperties="true"
                AutoSet="true">

        <HeaderInfo TypeName="Purchase Quote" TypeNamePlural="Purchase Quotes">
            <Title Path="quoteName"/>
            <Description Path="description"/>
        </HeaderInfo>

        <LineItem Qualifier="RelatedPurchaseRequest">
            <DataField Values="quoteName,partyId,statusId,validFromDate" Importance="High"/>
        </LineItem>

        <!--关联到采购请求单-->
        <NavigationProperty Name="PurchaseRequest" Type="PurchaseRequest" Relations="CustRequest" IsCollection="false"/>
        <!--关联到采购订单-->
        <NavigationProperty Name="PurchaseOrder" Type="PurchaseOrder" Relations="OrderHeader" IsCollection="true"/>

    </EntityType>

    <!--PurchaseOrder（订单）-->
    <EntityType Name="PurchaseOrder" OfbizEntity="OrderHeader" EntitySetName="PurchaseOrderHeaders"
                EntityCondition="orderTypeId=PURCHASE_ORDER" Properties="orderId,orderTypeId,orderName,orderDate,statusId,quoteId,agreementId"
                SearchOption="orderId,orderName,StatusItem/description">

        <HeaderInfo TypeName="Purchase Order" TypeNamePlural="Purchase Orders">
            <Title Path="orderId"/>
            <Description Path="orderName"/>
        </HeaderInfo>

        <LineItem Qualifier="RelatedQuote">
            <DataField Values="orderName,orderDate,statusId" Importance="High"/>
        </LineItem>

        <!--采购报价单-->
        <NavigationProperty Name="PurchaseQuote" Type="PurchaseQuote" Relations="Quote" IsCollection="false"/>

    </EntityType>

    <!-- ======================================子对象======================================-->
    <!--Product（产品）-->
    <EntityType Name="Product" EntitySetName="Products" AutoSet="true" AutoProperties="true"
                OfbizType="productTypeId=FINISHED_GOOD">
        <Property Name="quantityUomId" Immutable="true">
            <Text Path="QuantityUom/description" TextArrangement="TextOnly"/>
        </Property>
        <Property Name="primaryProductCategoryId">
            <Text Path="PrimaryProductCategory/categoryName" TextArrangement="TextOnly"/>
        </Property>
        <Property Name="productId">
            <Text Path="productName" TextArrangement="TextOnly"/>
        </Property>
        <Property Name="productName" Immutable="true"/>
        <NavigationProperty Name="QuantityUom"/>
        <NavigationProperty Name="PrimaryProductCategory"/>

    </EntityType>

    <!--Uom-->
    <EntityType Name="Uom" AutoProperties="true" AutoSet="true" EntitySetName="Unm">
        <Property Name="uomId">
            <Text Path="description" TextArrangement="TextLast"/>
        </Property>
    </EntityType>

    <!--ProductCategory-->
    <EntityType Name="ProductCategory" AutoSet="true" EntityCondition="productCategoryTypeId=SUPPLIER_CATEGORY"
                EntitySetName="ProductCategories" AutoProperties="true">
        <Property Name="productCategoryId">
            <Text Path="categoryName" TextArrangement="TextOnly"/>
        </Property>
    </EntityType>

    <!--Facility-->
    <EntityType Name="Facility" EntitySetName="Facilities" AutoProperties="true">
        <Property Name="facilityId">
            <Text Path="facilityName" TextArrangement="TextOnly"/>
        </Property>
    </EntityType>

    <!--CustRequestCategory-->
    <EntityType Name="CustRequestCategory" EntitySetName="CustRequestCategories" AutoProperties="true">
        <Property Name="custRequestCategoryId">
            <Text Path="description" TextArrangement="TextOnly"/>
        </Property>
    </EntityType>

    <!--CustRequestCategory(CatalogRequest的状态)-->
    <EntityType Name="CatalogRequestStatus" EntityCondition="statusTypeId=APTREQ_STTS" AutoProperties="true" EntitySetName="CatalogRequestStatuses" OfbizEntity="StatusItem">
        <Property Name="statusId">
            <Text Path="description" TextArrangement="TextOnly"/>
        </Property>
    </EntityType>

    <EntityType Name="CustRequestItem" EntitySetName="CustRequestItems" Properties="custRequestId,custRequestItemSeqId,productId,quantity,statusId,description,requiredByDate">
        <LineItem Qualifier="RelatedCatalogRequest">
            <DataField Values="custRequestItemSeqId,productId,quantity,statusId,description,requiredByDate" Importance="High"/>
            <DataFieldForAction Action="CreateCustRequestItem" Label="${Create}" Inline="false" Importance="High" Criticality="Positive" InvocationGrouping="Isolated"/>
            <DataFieldForAction Action="UpdateCustRequestItem" Label="${Update}" Inline="true" Importance="High" Criticality="Positive" InvocationGrouping="Isolated"/>
        </LineItem>

        <!--创建CustRequestItem-->
        <Action Name="CreateCustRequestItem" IsBound="true" EntitySetPath="custRequestItem" SideEffects="true"
                OfbizService="com.dpbird.odata.events.ActionEvents.createEntity">
            <Parameter Name="custRequestItem" Type="CustRequestItem" Nullable="false" IsCollection="true"/>
            <Parameter Name="productId" Type="String" Label="${ProductName}">
                <ValueList CollectionPath="Products" ParameterDisplayOnly="quantityUomId,primaryProductCategoryId">
                    <ParameterInOut ValueListProperty="productId" LocalDataProperty="productId"/>
                </ValueList>
            </Parameter>
            <Parameter Name="quantity" Type="BigDecimal" Scale="2" Label="${Quantity}"/>
            <Parameter Name="description" Type="String" Label="${Description}"/>
            <Parameter Name="requiredByDate" Type="Timestamp" Label="${RequiredByDate}"/>
        </Action>
        <!--编辑CustRequestItem-->
        <Action Name="UpdateCustRequestItem" IsBound="true" EntitySetPath="custRequestItem" SideEffects="true"
                OfbizService="com.dpbird.odata.events.ActionEvents.createEntity">
            <Parameter Name="custRequestItem" Type="CustRequestItem" Nullable="false" IsCollection="false"/>
            <Parameter Name="productId" Type="String" DefaultValue="custRequestItem/productId" Label="${ProductName}">
                <ValueList CollectionPath="Products" ParameterDisplayOnly="quantityUomId,primaryProductCategoryId">
                    <ParameterInOut ValueListProperty="productId" LocalDataProperty="productId"/>
                </ValueList>
            </Parameter>
            <Parameter Name="quantity" Type="BigDecimal" DefaultValue="custRequestItem/quantity" Scale="2" Label="${Quantity}"/>
            <Parameter Name="description" Type="String" DefaultValue="custRequestItem/description" Label="${Description}"/>
            <Parameter Name="requiredByDate" Type="Timestamp" DefaultValue="custRequestItem/requiredByDate" Label="${RequiredByDate}"/>
        </Action>
    </EntityType>



</ofbiz-edm>